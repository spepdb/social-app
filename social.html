<!-- File: /social.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Marginalia — Uncensored Social Prototype</title>
<style>
/* == Basic layout & theme == */
:root{
  --bg:#0f1720; --card:#0b1220; --muted:#98a1b2; --accent:#6ee7b7; --accent-2:#8b5cf6;
  --glass: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  --radius:12px; --maxw:1100px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
body{background:
 radial-gradient(800px 400px at 10% 10%, rgba(139,92,246,0.06), transparent 6%),
 linear-gradient(180deg,var(--bg),#071022 60%);
 color:#e6eef6; display:flex; align-items:center; justify-content:center; padding:24px;}
.app{width:100%; max-width:var(--maxw); display:grid; grid-template-columns:260px 1fr 300px; gap:20px; align-items:start;}
.header{grid-column:1/-1; display:flex; gap:12px; align-items:center; margin-bottom:6px;}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021017}
.topbar{margin-left:auto;display:flex;gap:8px;align-items:center}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 18px rgba(3,6,12,0.6);}
/* left column */
.left .user-mini{display:flex;gap:12px;align-items:center}
.avatar{width:68px;height:68px;border-radius:14px;background:linear-gradient(180deg,#09303a,#04202a);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);font-size:22px}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--accent);cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:0;color:#042022}
.small{font-size:13px;color:var(--muted)}
.follow-btn{padding:6px 10px;border-radius:10px;border:0;background:linear-gradient(90deg,#132a2b,#0b2730);cursor:pointer;color:var(--accent);font-weight:600}
.suggest-list{display:grid;gap:8px;margin-top:12px}
.suggest-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
/* mid column feed */
.center{min-height:60vh}
.composer{display:flex;gap:12px;align-items:flex-start}
.composer textarea{flex:1;min-height:64px;background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:12px;border-radius:10px;color:inherit;resize:vertical}
.composer .composer-actions{display:flex;flex-direction:column;gap:8px}
.feed{display:flex;flex-direction:column;gap:12px;margin-top:12px}
.post{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:12px;border-radius:12px;display:flex;gap:12px;align-items:flex-start}
.post .meta{display:flex;gap:8px;align-items:center}
.post .body{min-width:0}
.post img.post-image{max-width:100%;border-radius:10px;margin-top:8px;display:block;max-height:420px;object-fit:cover}
.post .actions{display:flex;gap:8px;margin-top:8px;align-items:center}
.icon{opacity:0.86}
.badge{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:999px;font-size:13px;color:var(--muted)}
.time{font-size:12px;color:var(--muted)}
.like-btn.liked{color:#ff7ab6}
.following{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px 10px;border-radius:999px}
.controls{display:flex;gap:8px;align-items:center}
/* right column */
.right .trends{display:flex;flex-direction:column;gap:8px}
.trend-item{display:flex;justify-content:space-between;padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.search{display:flex;gap:8px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02)}
.search input{background:transparent;border:0;outline:none;color:inherit;width:100%}
/* modal */
.modal{position:fixed;inset:0;background:rgba(2,6,12,0.6);display:flex;align-items:center;justify-content:center;padding:18px;z-index:40}
.modal .card{width:100%;max-width:680px}
.hidden{display:none!important}
/* tiny responsive */
@media (max-width:1000px){
  .app{grid-template-columns:1fr; padding:12px}
  .left,.right{display:none}
  .header{grid-column:1/-1}
}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header" style="grid-column:1/-1">
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <div style="font-size:18px">Marginalia</div>
        <div style="font-size:12px;color:var(--muted)">Uncensored prototype</div>
      </div>
    </div>

    <div class="topbar">
      <div class="search card" style="padding:8px 12px;width:320px;">
        <input id="globalSearch" placeholder="Search users or hashtags…" />
      </div>
      <button class="btn" id="btnNewPost">New Post</button>
      <div id="authArea"></div>
    </div>
  </div>

  <!-- LEFT -->
  <div class="left">
    <div class="card">
      <div id="leftUserCard" class="user-mini">
        <!-- filled by JS -->
      </div>
      <div style="margin-top:12px" class="small">Suggested accounts</div>
      <div class="suggest-list" id="suggestList"></div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center">
    <div class="card">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="feedAll">For you</button>
          <button class="btn" id="feedFollowing">Following</button>
        </div>
        <div class="small" id="feedInfo">Showing latest</div>
      </div>

      <div style="margin-top:12px" class="composer">
        <div id="miniAvatar" class="avatar">?</div>
        <textarea id="miniComposer" placeholder="Share something... (press Enter+Ctrl to post)"></textarea>
        <div class="composer-actions">
          <input type="file" id="miniImage" accept="image/*" style="display:none" />
          <button class="btn" id="miniAttach">Attach</button>
          <button class="btn primary" id="miniPost">Post</button>
        </div>
      </div>

      <div id="feed" class="feed" aria-live="polite"></div>
      <div id="feedLoader" style="text-align:center;padding:18px;color:var(--muted)">Scroll to load more…</div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Trends</div>
        <div class="small">Realtime-ish</div>
      </div>
      <div class="trends" id="trendsBox" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:700">About this demo</div>
      <div class="small" style="margin-top:8px;color:var(--muted)">
        This is a front-end prototype. Everything persists locally in your browser (localStorage). It intentionally includes no content moderation — use responsibly.
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="modalRoot"></div>
</div>

<script>
/* Minimal utilities */
const q = sel => document.querySelector(sel);
const qn = sel => Array.from(document.querySelectorAll(sel));
const uid = (n=8) => Math.random().toString(36).slice(2,2+n);

/* Persistence */
const STORAGE_KEY = 'marginalia.v1';
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return seedInitial();
    return JSON.parse(raw);
  }catch(e){return seedInitial();}
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* Simple password hash (demo only) */
function hashPassword(p){
  // tiny js hash — not secure, ok for demo persistence only
  let h=2166136261;
  for(let i=0;i<p.length;i++){h^=p.charCodeAt(i);h+= (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24)}
  return (h>>>0).toString(36);
}

/* Demo seed */
function seedInitial(){
  const alice = {id:'u_'+uid(6), username:'alice', displayName:'Alice Jun', bio:'I like sunsets & long code', avatarDataUrl:null, passwordHash:hashPassword('alice'), following:[], followersCount:0};
  const bob = {id:'u_'+uid(6), username:'bob', displayName:'Bob Chen', bio:'Open source tinkerer', avatarDataUrl:null, passwordHash:hashPassword('bob'), following:[alice.id], followersCount:0};
  const carol = {id:'u_'+uid(6), username:'carol', displayName:'Caroline', bio:'Poet & dev', avatarDataUrl:null, passwordHash:hashPassword('carol'), following:[], followersCount:0};
  const users = [alice,bob,carol];

  const posts = [
    {id:'p_'+uid(6), authorId:alice.id, text:"Hello Marginalia — first post! #hello #marginalia", imageDataUrl:null, timestamp:Date.now()-3600*1000*4, likes:[], replies:[]},
    {id:'p_'+uid(6), authorId:bob.id, text:"Testing uploads — here's a tiny color block.", imageDataUrl:makeColorDataURL('#8b5cf6'), timestamp:Date.now()-3600*1000*2, likes:[], replies:[]},
    {id:'p_'+uid(6), authorId:carol.id, text:"Poem: the server dreams in JSON.", imageDataUrl:null, timestamp:Date.now()-3600*1000*1, likes:[], replies:[]},
  ];
  // follower counts
  users.forEach(u => u.followersCount = users.filter(x => x.following && x.following.includes(u.id)).length);

  const s = {users, posts, session: {userId: bob.id}};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
  return s;
}

function makeColorDataURL(hex){
  // tiny colored PNG using SVG data URI (small)
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='400'><rect width='100%' height='100%' fill='${hex}'/></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/* App state */
let state = loadState();

/* Helpers to find entities */
function getUserById(id){ return state.users.find(u=>u.id===id) }
function getUserByUsername(un){ return state.users.find(u=>u.username.toLowerCase()===un.toLowerCase()) }
function getPostsSorted(){ return state.posts.slice().sort((a,b)=>b.timestamp-a.timestamp) }

/* UI rendering */
const feedEl = q('#feed');
const feedLoader = q('#feedLoader');
let feedMode = 'all'; // 'all'|'following'|'profile'
let activeProfile = null;
let feedCursor = 0;
const FEED_BATCH = 6;

/* Render left user card */
function renderLeft(){
  const container = q('#leftUserCard');
  container.innerHTML = '';
  const me = getCurrentUser();
  if(!me){
    const btn = document.createElement('button'); btn.className='btn primary'; btn.textContent='Sign up / Login';
    btn.onclick = ()=>showAuthModal();
    container.appendChild(btn);
    return;
  }
  const a = document.createElement('div'); a.style.flex=1;
  const av = document.createElement('div'); av.className='avatar'; av.textContent = me.displayName.split(' ').map(s=>s[0]).slice(0,2).join('');
  const info = document.createElement('div');
  info.innerHTML = `<div style="font-weight:700">${escapeHtml(me.displayName)} <span class="small">@${escapeHtml(me.username)}</span></div>
                    <div class="small" style="margin-top:6px;color:var(--muted)">${escapeHtml(me.bio || '')}</div>
                    <div style="margin-top:8px" class="small">@${me.followersCount} followers</div>`;
  container.appendChild(av); container.appendChild(info);
}

/* Suggested */
function renderSuggested(){
  const el = q('#suggestList'); el.innerHTML='';
  const me = getCurrentUser();
  state.users.slice(0,6).forEach(u=>{
    const item = document.createElement('div'); item.className='suggest-item';
    item.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
      <div class="avatar" style="width:44px;height:44px;border-radius:10px">${u.displayName.split(' ')[0][0]||'~'}</div>
      <div style="min-width:0">
        <div style="font-weight:700">${escapeHtml(u.displayName)}</div>
        <div class="small">@${escapeHtml(u.username)}</div>
      </div>
    </div>`;
    const btn = document.createElement('button'); btn.className = 'follow-btn';
    const isFollowing = me && me.following && me.following.includes(u.id);
    btn.textContent = isFollowing ? 'Following' : 'Follow';
    btn.onclick = (e)=>{
      e.stopPropagation();
      if(!me){ showAuthModal(); return; }
      toggleFollow(me.id, u.id);
      renderAll();
    };
    item.appendChild(btn);
    item.onclick = ()=>openProfile(u.username);
    el.appendChild(item);
  })
}

/* Feed */
function resetFeed(cursor=0){
  feedCursor = cursor;
  feedEl.innerHTML=''; feedLoader.style.display='block';
  renderFeedBatch();
}
function renderFeedBatch(){
  const allPosts = getPostsSorted();
  const filtered = allPosts.filter(p=>{
    if(feedMode==='all') return true;
    if(feedMode==='following'){
      const me = getCurrentUser();
      if(!me) return false;
      return me.following.includes(p.authorId);
    }
    if(feedMode==='profile'){
      if(!activeProfile) return false;
      return p.authorId === activeProfile.id;
    }
    return true;
  });
  const batch = filtered.slice(feedCursor, feedCursor+FEED_BATCH);
  batch.forEach(renderPost);
  feedCursor += batch.length;
  if(feedCursor >= filtered.length) feedLoader.style.display='none';
  else feedLoader.style.display='block';
}

/* Render a single post element */
function renderPost(p){
  const author = getUserById(p.authorId) || {displayName:'Unknown', username:'unknown'};
  const me = getCurrentUser();
  const el = document.createElement('div'); el.className='post';
  el.innerHTML = `
    <div class="meta">
      <div class="avatar" style="width:56px;height:56px;border-radius:10px">${author.displayName[0]||'?'}</div>
    </div>
    <div class="body" style="flex:1">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">${escapeHtml(author.displayName)} <span class="small">@${escapeHtml(author.username)}</span></div>
          <div class="time small">${timeAgo(p.timestamp)}</div>
        </div>
        <div class="controls">
          ${me && me.id !== author.id ? `<button class="btn follow-btn small" data-follow="${author.id}">${me && me.following && me.following.includes(author.id)?'Following':'Follow'}</button>` : ''}
          ${me && me.id===author.id ? `<button class="btn small" data-delete="${p.id}">Delete</button>` : ''}
        </div>
      </div>
      <div class="text" style="margin-top:8px;white-space:pre-wrap">${linkify(escapeHtml(p.text))}</div>
      ${p.imageDataUrl ? `<img class="post-image" src="${p.imageDataUrl}" alt="post image" />` : ''}
      <div class="actions">
        <button class="btn like-btn ${me && p.likes.includes(me.id) ? 'liked' : ''}" data-like="${p.id}">♥ <span class="small">${p.likes.length}</span></button>
        <button class="btn" data-reply="${p.id}">↩ Reply <span class="small">${p.replies.length||0}</span></button>
      </div>
    </div>
  `;
  // hooks
  el.querySelectorAll('[data-like]').forEach(btn=>{
    btn.onclick = ()=>{
      if(!me){ showAuthModal(); return; }
      toggleLike(me.id, btn.getAttribute('data-like'));
      refreshFeedUI();
    }
  });
  el.querySelectorAll('[data-follow]').forEach(btn=>{
    btn.onclick = (e)=>{
      e.stopPropagation();
      if(!me){ showAuthModal(); return; }
      const targetId = btn.getAttribute('data-follow');
      toggleFollow(me.id, targetId);
      refreshFeedUI();
      renderSuggested();
    }
  });
  el.querySelectorAll('[data-delete]').forEach(btn=>{
    btn.onclick = ()=>{
      const pid = btn.getAttribute('data-delete');
      deletePost(pid);
      refreshFeedUI(true);
    }
  });
  el.querySelectorAll('[data-reply]').forEach(btn=>{
    btn.onclick = ()=>{
      showReplyModal(p.id);
    }
  });
  feedEl.appendChild(el);
}

/* Utility actions */
function toggleLike(userId, postId){
  const post = state.posts.find(p=>p.id===postId);
  if(!post) return;
  const idx = post.likes.indexOf(userId);
  if(idx>=0) post.likes.splice(idx,1);
  else post.likes.push(userId);
  saveState();
}
function toggleFollow(meId, targetId){
  if(meId===targetId) return;
  const me = getUserById(meId);
  const t = getUserById(targetId);
  if(!me||!t) return;
  const idx = me.following.indexOf(targetId);
  if(idx>=0){ me.following.splice(idx,1); t.followersCount = Math.max(0,(t.followersCount||0)-1); }
  else { me.following.push(targetId); t.followersCount = (t.followersCount||0)+1; }
  saveState();
}
function deletePost(postId){
  const i = state.posts.findIndex(p=>p.id===postId);
  if(i>=0) state.posts.splice(i,1);
  saveState();
}

/* Compose */
q('#miniAttach').onclick = ()=> q('#miniImage').click();
q('#miniImage').onchange = async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const data = await fileToDataUrl(f);
  q('#miniComposer').dataset.image = data;
}
q('#miniPost').onclick = ()=> createMiniPost();
q('#btnNewPost').onclick = ()=> showCreateModal();
q('#miniComposer').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && e.ctrlKey){ e.preventDefault(); createMiniPost(); }
});
async function createMiniPost(){
  const me = getCurrentUser();
  if(!me){ showAuthModal(); return; }
  const text = q('#miniComposer').value.trim();
  const img = q('#miniComposer').dataset.image || null;
  if(!text && !img) return alert('Write something or attach an image.');
  state.posts.push({id:'p_'+uid(6), authorId:me.id, text, imageDataUrl:img, timestamp:Date.now(), likes:[], replies:[]});
  // clear
  q('#miniComposer').value=''; delete q('#miniComposer').dataset.image;
  saveState();
  refreshFeedUI(true);
}

/* Reply modal */
function showReplyModal(postId){
  const post = state.posts.find(p=>p.id===postId);
  if(!post) return;
  const author = getUserById(post.authorId) || {};
  const tpl = document.createElement('div'); tpl.className='modal';
  tpl.innerHTML = `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Reply to ${escapeHtml(author.username)}</div>
      <button class="btn" id="closeReply">Close</button>
    </div>
    <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.02);padding-top:10px">
      <div style="white-space:pre-wrap">${escapeHtml(post.text)}</div>
      ${post.imageDataUrl?'<img style="max-width:100%;margin-top:8px" src="'+post.imageDataUrl+'">':''}
      <textarea id="replyText" style="width:100%;margin-top:10px;height:100px;background:transparent;color:inherit;border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.04)"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn primary" id="sendReply">Send</button>
        <button class="btn" id="cancelReply">Cancel</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(tpl);
  tpl.querySelector('#closeReply').onclick = ()=> tpl.remove();
  tpl.querySelector('#cancelReply').onclick = ()=> tpl.remove();
  tpl.querySelector('#sendReply').onclick = ()=>{
    const t = tpl.querySelector('#replyText').value.trim();
    const me = getCurrentUser();
    if(!me){ showAuthModal(); tpl.remove(); return; }
    if(!t) return alert('Reply cannot be empty');
    post.replies.push({id:'r_'+uid(6), authorId:me.id, text:t, timestamp:Date.now()});
    saveState();
    tpl.remove();
    refreshFeedUI();
  }
}

/* Create modal */
function showCreateModal(){
  const tpl = document.createElement('div'); tpl.className='modal';
  tpl.innerHTML = `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">New Post</div>
      <button class="btn" id="closeCreate">Close</button>
    </div>
    <div style="margin-top:8px">
      <textarea id="createText" style="width:100%;height:140px;background:transparent;color:inherit;border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.04)"></textarea>
      <input type="file" id="createImg" accept="image/*" style="margin-top:8px" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn primary" id="createSend">Post</button>
        <button class="btn" id="createCancel">Cancel</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(tpl);
  tpl.querySelector('#closeCreate').onclick = ()=> tpl.remove();
  tpl.querySelector('#createCancel').onclick = ()=> tpl.remove();
  tpl.querySelector('#createSend').onclick = async ()=>{
    const me = getCurrentUser();
    if(!me){ tpl.remove(); showAuthModal(); return; }
    const text = tpl.querySelector('#createText').value.trim();
    const f = tpl.querySelector('#createImg').files[0];
    const img = f ? await fileToDataUrl(f) : null;
    if(!text && !img) return alert('Write something or attach image.');
    state.posts.unshift({id:'p_'+uid(6), authorId:me.id, text, imageDataUrl:img, timestamp:Date.now(), likes:[], replies:[]});
    saveState();
    tpl.remove();
    refreshFeedUI(true);
  };
}

/* Auth modal */
function showAuthModal(){
  const tpl = document.createElement('div'); tpl.className='modal';
  tpl.innerHTML = `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Sign in / Sign up</div>
      <button class="btn" id="closeAuth">Close</button>
    </div>
    <div style="margin-top:8px">
      <div style="display:flex;gap:8px">
        <input id="authUser" placeholder="username" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)"/>
        <input id="authPass" type="password" placeholder="password" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)"/>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn primary" id="authLogin">Login</button>
        <button class="btn" id="authSignup">Sign up</button>
      </div>
      <div style="margin-top:8px" class="small">Tip: demo users: alice / bob / carol (password = their name)</div>
    </div>
  </div>`;
  document.body.appendChild(tpl);
  tpl.querySelector('#closeAuth').onclick = ()=> tpl.remove();
  tpl.querySelector('#authLogin').onclick = ()=>{
    const u = tpl.querySelector('#authUser').value.trim();
    const p = tpl.querySelector('#authPass').value;
    if(!u||!p) return alert('Enter credentials');
    const user = getUserByUsername(u);
    if(!user || user.passwordHash !== hashPassword(p)) { alert('Invalid credentials'); return; }
    state.session.userId = user.id;
    saveState();
    tpl.remove();
    refreshAll();
  };
  tpl.querySelector('#authSignup').onclick = ()=>{
    const u = tpl.querySelector('#authUser').value.trim();
    const p = tpl.querySelector('#authPass').value;
    if(!u||!p) return alert('Enter username & password');
    if(getUserByUsername(u)) return alert('Username taken');
    const newU = {id:'u_'+uid(6), username:u, displayName:u, bio:'', avatarDataUrl:null, passwordHash:hashPassword(p), following:[], followersCount:0};
    state.users.push(newU);
    state.session.userId = newU.id;
    saveState();
    tpl.remove();
    refreshAll();
  }
}

/* Profile view (by username) */
function openProfile(username){
  const u = getUserByUsername(username);
  if(!u) return alert('Profile not found');
  activeProfile = u; feedMode='profile';
  resetFeed(); // reload feed filtered to profile
  q('#feedInfo').textContent = 'Profile — ' + u.displayName;
}

/* Helpers for UI refresh */
function refreshFeedUI(reset=false){
  if(reset) resetFeed(0);
  else {
    // re-render minimal: clear feed and re-render from start to currently loaded cursor
    feedEl.innerHTML=''; feedCursor=0;
    renderFeedBatch();
  }
  renderHeaderAuth();
}
function refreshAll(){
  renderLeft(); renderSuggested(); refreshFeedUI(true); renderTrends(); renderHeaderAuth(); renderMiniAvatar();
}

/* Header auth area */
function renderHeaderAuth(){
  const area = q('#authArea'); area.innerHTML='';
  const me = getCurrentUser();
  if(!me){
    const b = document.createElement('button'); b.className='btn'; b.textContent='Login'; b.onclick = showAuthModal;
    area.appendChild(b);
  }else{
    const name = document.createElement('div'); name.style.display='flex'; name.style.gap='8px'; name.style.alignItems='center';
    const av = document.createElement('div'); av.className='avatar'; av.style.width='38px'; av.style.height='38px'; av.textContent=me.displayName[0]||'?';
    const span = document.createElement('div'); span.innerHTML = `<div style="font-weight:700">${escapeHtml(me.displayName)}</div><div class="small">@${escapeHtml(me.username)}</div>`;
    const outbtn = document.createElement('button'); outbtn.className='btn'; outbtn.textContent='Logout';
    outbtn.onclick = ()=>{ state.session.userId = null; saveState(); refreshAll(); };
    span.onclick = ()=>openProfile(me.username);
    name.appendChild(av); name.appendChild(span); name.appendChild(outbtn);
    area.appendChild(name);
  }
}
function renderMiniAvatar(){
  const me = getCurrentUser();
  const el = q('#miniAvatar');
  el.textContent = me ? (me.displayName.split(' ').map(s=>s[0]).slice(0,2).join('')) : '?';
}

/* Trends (hashtags) */
function renderTrends(){
  const box = q('#trendsBox'); box.innerHTML='';
  const map = {};
  state.posts.forEach(p=>{
    (p.text.match(/#\w+/g)||[]).forEach(tag=>{
      map[tag] = (map[tag]||0)+1;
    })
  });
  const items = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,6);
  if(items.length===0){
    box.innerHTML = '<div class="small" style="color:var(--muted)">No trends yet — make one!</div>'; return;
  }
  items.forEach(([tag,c])=>{
    const d = document.createElement('div'); d.className='trend-item';
    d.innerHTML = `<div style="font-weight:700">${escapeHtml(tag)}</div><div class="small">${c}</div>`;
    d.onclick = ()=> searchTag(tag);
    box.appendChild(d);
  });
}

/* Search handler */
q('#globalSearch').addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){ performSearch(q('#globalSearch').value.trim()); }
});
function performSearch(qs){
  if(!qs) return;
  // search users first
  const user = state.users.find(u=>u.username.toLowerCase()===qs.toLowerCase() || u.displayName.toLowerCase()===qs.toLowerCase());
  if(user){ openProfile(user.username); return; }
  // fallback: search hashtag
  if(qs.startsWith('#')) return searchTag(qs);
  // substring search in users / posts
  const matched = state.users.filter(u=>u.username.toLowerCase().includes(qs.toLowerCase())||u.displayName.toLowerCase().includes(qs.toLowerCase()));
  if(matched.length>0){ openProfile(matched[0].username); return; }
  alert('No results found for: '+qs);
}
function searchTag(tag){
  // filter feed to posts that include that tag
  feedMode='all';
  const filtered = getPostsSorted().filter(p=>p.text.includes(tag));
  activeProfile = null;
  feedEl.innerHTML='';
  filtered.forEach(renderPost);
  feedLoader.style.display='none';
  q('#feedInfo').textContent = 'Search: ' + tag;
}

/* Utilities */
function getCurrentUser(){ return state.users.find(u=>u.id=== (state.session && state.session.userId) ) }
function fileToDataUrl(file){ return new Promise((res,rej)=>{ const r = new FileReader(); r.onload = ()=>res(r.result); r.onerror = rej; r.readAsDataURL(file); }) }
function timeAgo(ts){
  const s = Math.floor((Date.now()-ts)/1000);
  if(s<60) return s+'s';
  if(s<3600) return Math.floor(s/60)+'m';
  if(s<3600*24) return Math.floor(s/3600)+'h';
  return new Date(ts).toLocaleDateString();
}
function escapeHtml(t){ return t.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
function linkify(text){
  // hashtags and @mentions
  return text.replace(/#(\w+)/g, (m,tag)=>`<a href="#" style="color:var(--accent)" onclick="(function(){performSearch('#${tag}')})()">${m}</a>`)
             .replace(/@(\w+)/g, (m,u)=>`<a href="#" style="color:var(--accent)" onclick="(function(){performSearch('${u}')})()">${m}</a>`);
}

/* Refresh / init */
function renderTrendsThrottled(){ renderTrends(); }
function renderAll(){ renderLeft(); renderSuggested(); renderHeaderAuth(); renderMiniAvatar(); resetFeed(); renderTrends(); }
function refreshFeedAndTrends(){ refreshFeedUI(true); renderTrends(); }

/* small helpers to update UI after edits */
function refreshFeedUIAndSave(){ saveState(); refreshFeedUI(true); }

/* On-scroll loading */
document.querySelector('.center').addEventListener('scroll', (e)=>{
  const el = e.currentTarget;
  if(el.scrollTop + el.clientHeight > el.scrollHeight - 120){
    renderFeedBatch();
  }
});
// But center scroll may not be tall; also add window near-bottom check
window.addEventListener('scroll', ()=>{
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 180){
    renderFeedBatch();
  }
});

/* Mini helpers */
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;') }

/* Init */
renderAll();

/* Expose a few functions globally so generated markup onclick handlers can call them */
window.performSearch = performSearch;
window.openProfile = openProfile;

/* END */
</script>
</body>
</html>
